<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>MySQL数据库集群-PXC方案 | Enmin`s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="Enmin,ZEnmin's Blog" />
  
  <meta name="description" content="一、安装Percona数据库1. 离线安装Percona 进入RPM安装文件目录，执行下面的脚本 1yum localinstall *.rpm  管理MySQL服务 123systemctl start mysqldsystemctl stop mysqldsystemctl restart mysqld   2. 在线安装Percona 使用yum命令安装 12yum install http">
<meta name="keywords" content="Mysql,数据库集群">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL数据库集群-PXC方案">
<meta property="og:url" content="https://zem12345678.github.io/2019/03/18/MySQL数据库集群-PXC方案/index.html">
<meta property="og:site_name" content="Enmin`s blog">
<meta property="og:description" content="一、安装Percona数据库1. 离线安装Percona 进入RPM安装文件目录，执行下面的脚本 1yum localinstall *.rpm  管理MySQL服务 123systemctl start mysqldsystemctl stop mysqldsystemctl restart mysqld   2. 在线安装Percona 使用yum命令安装 12yum install http">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-03-18T14:32:36.792Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL数据库集群-PXC方案">
<meta name="twitter:description" content="一、安装Percona数据库1. 离线安装Percona 进入RPM安装文件目录，执行下面的脚本 1yum localinstall *.rpm  管理MySQL服务 123systemctl start mysqldsystemctl stop mysqldsystemctl restart mysqld   2. 在线安装Percona 使用yum命令安装 12yum install http">
  
  
    <link rel="icon" href="/favicon1.ico">
  
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/pace.min.js"></script>
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-127786403-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?4802669a9f01ae631292334aca36a944";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>

  
  <div style="display: none;">
    <script src="//s22.cnzz.com/z_stat.php?id=1275093534&web_id=1275093534" language="JavaScript"></script>
  </div>


</head>

<body>
  <div id="container">
      <header id="header">
    <div id="banner"></div>
    <div id="header-outer">
        <div id="header-menu" class="header-menu-pos animated">
            <div class="header-menu-container">
                <a href="/" class="left">
                    <span class="site-title">Enmin&#39;s Blog</span>
                </a>
                <nav id="header-menu-nav" class="right">
                    
                    <a  href="/">
                        <i class="fa fa-home"></i>
                        <span>主页</span>
                    </a>
                    
                    <a  href="/archives">
                        <i class="fa fa-archive"></i>
                        <span>文章</span>
                    </a>
                    
                    <a  href="/about">
                        <i class="fa fa-user"></i>
                        <span>关于我</span>
                    </a>
                    
                </nav>
                <a class="mobile-header-menu-button">
                    <i class="fa fa-bars"></i>
                </a>
            </div>
        </div>
        <div id="header-row">
            <div id="logo">
                <a href="/">
                    <img src="/images/logo.png" alt="logo">
                </a>
            </div>
            <div class="header-info">
                <div id="header-title">
                    
                    <h2>
                        Enmin&#39;s Blog
                    </h2>
                    
                </div>
                <div id="header-description">
                    
                    <h3>
                        漫宅万岁，bilibili (゜-゜)つロ 乾杯~-
                    </h3>
                    
                </div>
            </div>
            <nav class="header-nav">
                <div class="social">
                    
                        <a title="zem12345678" target="_blank" href="//https://zem12345678.github.io/">
                            <i class="fa fa-home fa-2x"></i></a>
                    
                        <a title="Github" target="_blank" href="//github.com/zem12345678">
                            <i class="fa fa-github fa-2x"></i></a>
                    
                        <a title="Weibo" target="_blank" href="//weibo.com/zem12345678">
                            <i class="fa fa-weibo fa-2x"></i></a>
                    
                        <a title="Twitter" target="_blank" href="//twitter.com/Enmin_zhang">
                            <i class="fa fa-twitter fa-2x"></i></a>
                    
                </div>
            </nav>
        </div>
    </div>
</header>
      <div class="outer">
        <section id="main" class="body-wrap"><article id="post-MySQL数据库集群-PXC方案" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="post-title" itemprop="name">
      MySQL数据库集群-PXC方案
    </h1>
    <div class="post-title-bar">
      <ul>
          
              <li>
                  <i class="fa fa-book"></i>
                  
                      <a href="/categories/数据库/">数据库</a>
                  
              </li>
          
        <li>
          <i class="fa fa-calendar"></i>  2019-03-18
        </li>
        <li>
          <i class="fa fa-eye"></i>
          <span id="busuanzi_value_page_pv"></span>
        </li>
      </ul>
    </div>
  

          
      </header>
    
    <div class="article-entry post-content" itemprop="articleBody">
      
            
            <h1 id="一、安装Percona数据库"><a href="#一、安装Percona数据库" class="headerlink" title="一、安装Percona数据库"></a>一、安装Percona数据库</h1><h2 id="1-离线安装Percona"><a href="#1-离线安装Percona" class="headerlink" title="1. 离线安装Percona"></a>1. 离线安装Percona</h2><ul>
<li><p>进入RPM安装文件目录，执行下面的脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall *.rpm</span><br></pre></td></tr></table></figure>
</li>
<li><p>管理MySQL服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysqld</span><br><span class="line">systemctl stop mysqld</span><br><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="2-在线安装Percona"><a href="#2-在线安装Percona" class="headerlink" title="2. 在线安装Percona"></a>2. 在线安装Percona</h2><ul>
<li><p>使用yum命令安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install http://www.percona.com/downloads/percona-release/redhat/0.1-3/percona-release-0.1-3.noarch.rpm</span><br><span class="line">yum  install  Percona-Server-server-57</span><br></pre></td></tr></table></figure>
</li>
<li><p>管理MySQL服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service mysql start</span><br><span class="line">service mysql stop</span><br><span class="line">service mysql restart</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="3-开放防火墙端口"><a href="#3-开放防火墙端口" class="headerlink" title="3. 开放防火墙端口"></a>3. 开放防火墙端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=3306/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<h2 id="4-修改MySQL配置文件"><a href="#4-修改MySQL配置文件" class="headerlink" title="4. 修改MySQL配置文件"></a>4. 修改MySQL配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">character_set_server</span> = utf8</span><br><span class="line"><span class="attr">bind-address</span> = <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="comment">#跳过DNS解析</span></span><br><span class="line">skip-name-resolve</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql restart</span><br></pre></td></tr></table></figure>
<h2 id="5-禁止开机启动MySQL"><a href="#5-禁止开机启动MySQL" class="headerlink" title="5. 禁止开机启动MySQL"></a>5. 禁止开机启动MySQL</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig mysqld off</span><br></pre></td></tr></table></figure>
<h2 id="6-初始化MySQL数据库"><a href="#6-初始化MySQL数据库" class="headerlink" title="6. 初始化MySQL数据库"></a>6. 初始化MySQL数据库</h2><ul>
<li><p>查看MySQL初始密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /var/log/mysqld.log | grep "A temporary password"</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改MySQL密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建远程管理员账户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'admin'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'Abc_123456'</span>;</span><br><span class="line"><span class="keyword">GRANT</span> all <span class="keyword">privileges</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'admin'</span>@<span class="string">'%'</span>;</span><br><span class="line"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="二、创建PXC集群"><a href="#二、创建PXC集群" class="headerlink" title="二、创建PXC集群"></a>二、创建PXC集群</h1><h2 id="1-删除MariaDB程序包"><a href="#1-删除MariaDB程序包" class="headerlink" title="1. 删除MariaDB程序包"></a>1. 删除MariaDB程序包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y remove mari*</span><br></pre></td></tr></table></figure>
<h2 id="2-开放防火墙端口"><a href="#2-开放防火墙端口" class="headerlink" title="2. 开放防火墙端口"></a>2. 开放防火墙端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=3306/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=4444/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=4567/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=4568/tcp --permanent</span><br></pre></td></tr></table></figure>
<h2 id="3-关闭SELINUX"><a href="#3-关闭SELINUX" class="headerlink" title="3. 关闭SELINUX"></a>3. 关闭SELINUX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/selinux/config</span><br></pre></td></tr></table></figure>
<p>把SELINUX属性值设置成disabled</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h2 id="4-离线安装PXC"><a href="#4-离线安装PXC" class="headerlink" title="4. 离线安装PXC"></a>4. 离线安装PXC</h2><ul>
<li><p>进入RPM文件目录，执行安装命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall *.rpm</span><br></pre></td></tr></table></figure>
</li>
<li><p>参考第一章内容，修改MySQL配置文件、创建账户等操作</p>
</li>
</ul>
<h2 id="5-创建PXC集群"><a href="#5-创建PXC集群" class="headerlink" title="5. 创建PXC集群"></a>5. 创建PXC集群</h2><ul>
<li><p>停止MySQL服务</p>
</li>
<li><p>修改每个PXC节点的/etc/my.cnf文件（在不同节点上，注意调整文件内容）</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server-id</span>=<span class="number">1</span>  #PXC集群中MySQL实例的唯一ID，不能重复，必须是数字</span><br><span class="line"><span class="attr">wsrep_provider</span>=/usr/lib64/galera3/libgalera_smm.so</span><br><span class="line"><span class="attr">wsrep_cluster_name</span>=pxc-cluster  #PXC集群的名称</span><br><span class="line"><span class="attr">wsrep_cluster_address</span>=gcomm://<span class="number">192.168</span>.<span class="number">99.151</span>,<span class="number">192.168</span>.<span class="number">99.159</span>,<span class="number">192.168</span>.<span class="number">99.215</span></span><br><span class="line"><span class="attr">wsrep_node_name</span>=pxc1  #当前节点的名称</span><br><span class="line"><span class="attr">wsrep_node_address</span>=<span class="number">192.168</span>.<span class="number">99.151</span>  #当前节点的IP</span><br><span class="line"><span class="attr">wsrep_sst_method</span>=xtrabackup-v2  #同步方法（mysqldump、rsync、xtrabackup）</span><br><span class="line"><span class="attr">wsrep_sst_auth</span>= admin:Abc_123456  #同步使用的帐户</span><br><span class="line"><span class="attr">pxc_strict_mode</span>=ENFORCING  #同步严厉模式</span><br><span class="line"><span class="attr">binlog_format</span>=ROW  #基于ROW复制（安全可靠）</span><br><span class="line"><span class="attr">default_storage_engine</span>=InnoDB  #默认引擎</span><br><span class="line"><span class="attr">innodb_autoinc_lock_mode</span>=<span class="number">2</span>  #主键自增长不锁表</span><br></pre></td></tr></table></figure>
</li>
<li><p>主节点的管理命令（第一个启动的PXC节点）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysql@bootstrap.service</span><br><span class="line">systemctl stop mysql@bootstrap.service</span><br><span class="line">systemctl restart mysql@bootstrap.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>非主节点的管理命令（非第一个启动的PXC节点）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service start mysql</span><br><span class="line">service stop mysql</span><br><span class="line">service restart mysql</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看PXC集群状态信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show status like &apos;wsrep_cluster%&apos; ;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>按照上述配置方法，创建两组PXC集群</strong></p>
</li>
</ul>
<h2 id="6-PXC节点启动与关闭"><a href="#6-PXC节点启动与关闭" class="headerlink" title="6. PXC节点启动与关闭"></a>6. PXC节点启动与关闭</h2><ul>
<li>如果最后关闭的PXC节点是安全退出的，那么下次启动要最先启动这个节点，而且要以主节点启动</li>
<li>如果最后关闭的PXC节点不是安全退出的，那么要先修改<code>/var/lib/mysql/grastate.dat</code> 文件，把其中的<code>safe_to_bootstrap</code>属性值设置为1，再安装主节点启动</li>
</ul>
<h1 id="三、安装MyCat"><a href="#三、安装MyCat" class="headerlink" title="三、安装MyCat"></a>三、安装MyCat</h1><h2 id="1-JDK安装与配置"><a href="#1-JDK安装与配置" class="headerlink" title="1. JDK安装与配置"></a>1. JDK安装与配置</h2><ul>
<li><p>安装JDK</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>搜索JDK版本</span><br><span class="line">yum search jdk </span><br><span class="line"><span class="meta">#</span>安装JDK1.8开发版</span><br><span class="line">yum install java-1.8.0-openjdk-devel.x86_64</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>查看JDK安装路径</span><br><span class="line">ls -lrt /etc/alternatives/java</span><br><span class="line">vi /etc/profile</span><br><span class="line"><span class="meta">#</span>在文件结尾加上JDK路径，例如export  JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.171-8.b10.el7_5.x86_64/</span><br><span class="line">source  /etc/profile</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="2-创建数据表"><a href="#2-创建数据表" class="headerlink" title="2. 创建数据表"></a>2. 创建数据表</h2><ul>
<li><p>在两组PXC集群中分别创建t_user数据表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t_user(</span><br><span class="line">	id INT UNSIGNED PRIMARY KEY,</span><br><span class="line">    username VARCHAR(200) NOT NULL,</span><br><span class="line">    password VARCHAR(2000) NOT NULL,</span><br><span class="line">    tel CHAR(11) NOT NULL,</span><br><span class="line">    locked TINYINT(1) UNSIGNED NOT NULL DEFAULT 0,</span><br><span class="line">    INDEX idx_username(username) USING BTREE,</span><br><span class="line">    UNIQUE INDEX unq_username(username) USING BTREE</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="3-MyCat安装与配置"><a href="#3-MyCat安装与配置" class="headerlink" title="3. MyCat安装与配置"></a>3. MyCat安装与配置</h2><ol>
<li><p>下载MyCat</p>
<p><a href="http://dl.mycat.io/1.6.5/Mycat-server-1.6.5-release-20180122220033-linux.tar.gz" target="_blank" rel="noopener">http://dl.mycat.io/1.6.5/Mycat-server-1.6.5-release-20180122220033-linux.tar.</a><a href="http://dl.mycat.io/1.6.5/Mycat-server-1.6.5-release-20180122220033-linux.tar.gz" target="_blank" rel="noopener">gz</a></p>
</li>
<li><p>上传MyCat压缩包到虚拟机</p>
</li>
<li><p>安装unzip程序包，解压缩MyCat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install unzip</span><br><span class="line">unzip MyCAT压缩包名称</span><br></pre></td></tr></table></figure>
</li>
<li><p>开放防火墙8066和9066端口，关闭SELINUX</p>
</li>
<li><p>修改MyCat的bin目录中所有.sh文件的权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 777 ./*.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>MyCat启动与关闭</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>cd MyCat的bin目录</span><br><span class="line">./startup_nowrap.sh #启动MyCat</span><br><span class="line">ps -aux #查看系统进程</span><br><span class="line">kill -9 MyCat进程编号</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改server.xml文件，设置MyCat帐户和虚拟逻辑库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line">&lt;!DOCTYPE mycat:server SYSTEM "server.dtd"&gt;</span><br><span class="line">&lt;mycat:server xmlns:mycat="http://io.mycat/"&gt;</span><br><span class="line">  	&lt;system&gt;</span><br><span class="line">  		&lt;property name="nonePasswordLogin"&gt;0&lt;/property&gt;</span><br><span class="line">  		&lt;property name="useHandshakeV10"&gt;1&lt;/property&gt;</span><br><span class="line">  		&lt;property name="useSqlStat"&gt;0&lt;/property&gt;</span><br><span class="line">  		&lt;property name="useGlobleTableCheck"&gt;0&lt;/property&gt;</span><br><span class="line">  		&lt;property name="sequnceHandlerType"&gt;2&lt;/property&gt;</span><br><span class="line">  		&lt;property name="subqueryRelationshipCheck"&gt;false&lt;/property&gt;</span><br><span class="line">  		&lt;property name="processorBufferPoolType"&gt;0&lt;/property&gt;</span><br><span class="line">  		&lt;property name="handleDistributedTransactions"&gt;0&lt;/property&gt;</span><br><span class="line">  		&lt;property name="useOffHeapForMerge"&gt;1&lt;/property&gt;</span><br><span class="line">      	&lt;property name="memoryPageSize"&gt;64k&lt;/property&gt;</span><br><span class="line">  		&lt;property name="spillsFileBufferSize"&gt;1k&lt;/property&gt;</span><br><span class="line">  		&lt;property name="useStreamOutput"&gt;0&lt;/property&gt;</span><br><span class="line">  		&lt;property name="systemReserveMemorySize"&gt;384m&lt;/property&gt;</span><br><span class="line">  		&lt;property name="useZKSwitch"&gt;false&lt;/property&gt;</span><br><span class="line">  	&lt;/system&gt;</span><br><span class="line">    &lt;!--这里是设置的admin用户和虚拟逻辑库--&gt;</span><br><span class="line">  	&lt;user name="admin" defaultAccount="true"&gt;</span><br><span class="line">  		&lt;property name="password"&gt;Abc_123456&lt;/property&gt;</span><br><span class="line">  		&lt;property name="schemas"&gt;test&lt;/property&gt;</span><br><span class="line">  	&lt;/user&gt;</span><br><span class="line">&lt;/mycat:server&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="8">
<li><p>修改schema.xml文件，设置数据库连接和虚拟数据表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line">&lt;!DOCTYPE mycat:schema SYSTEM "schema.dtd"&gt;</span><br><span class="line">&lt;mycat:schema xmlns:mycat="http://io.mycat/"&gt;</span><br><span class="line">  	&lt;!--配置数据表--&gt;</span><br><span class="line">  	&lt;schema name="test" checkSQLschema="false" sqlMaxLimit="100"&gt;</span><br><span class="line">  		&lt;table name="t_user" dataNode="dn1,dn2" rule="mod-long" /&gt;</span><br><span class="line">  	&lt;/schema&gt;</span><br><span class="line">  	&lt;!--配置分片关系--&gt;</span><br><span class="line">  	&lt;dataNode name="dn1" dataHost="cluster1" database="test" /&gt;</span><br><span class="line">  	&lt;dataNode name="dn2" dataHost="cluster2" database="test" /&gt;</span><br><span class="line">  	&lt;!--配置连接信息--&gt;</span><br><span class="line">  	&lt;dataHost name="cluster1" maxCon="1000" minCon="10" balance="2" </span><br><span class="line">                writeType="1" dbType="mysql" dbDriver="native" switchType="1"  </span><br><span class="line">                slaveThreshold="100"&gt;</span><br><span class="line">  		&lt;heartbeat&gt;select user()&lt;/heartbeat&gt;</span><br><span class="line">  		&lt;writeHost host="W1" url="192.168.99.151:3306" user="admin" </span><br><span class="line">                     password="Abc_123456"&gt;</span><br><span class="line">  			&lt;readHost host="W1R1" url="192.168.99.159:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  			&lt;readHost host="W1R2" url="192.168.99.215:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  		&lt;/writeHost&gt;</span><br><span class="line">  		&lt;writeHost host="W2" url="192.168.99.159:3306" user="admin" </span><br><span class="line">                     password="Abc_123456"&gt;</span><br><span class="line">  			&lt;readHost host="W2R1" url="192.168.99.151:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  			&lt;readHost host="W2R2" url="192.168.99.215:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  		&lt;/writeHost&gt;</span><br><span class="line">  	&lt;/dataHost&gt;</span><br><span class="line">  	&lt;dataHost name="cluster2" maxCon="1000" minCon="10" balance="2" </span><br><span class="line">                writeType="1" dbType="mysql" dbDriver="native" switchType="1"  </span><br><span class="line">                slaveThreshold="100"&gt;</span><br><span class="line">  		&lt;heartbeat&gt;select user()&lt;/heartbeat&gt;</span><br><span class="line">  		&lt;writeHost host="W1" url="192.168.99.121:3306" user="admin"</span><br><span class="line">  				   password="Abc_123456"&gt;</span><br><span class="line">  			&lt;readHost host="W1R1" url="192.168.99.122:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  			&lt;readHost host="W1R2" url="192.168.99.123:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  		&lt;/writeHost&gt;</span><br><span class="line">  		&lt;writeHost host="W2" url="192.168.99.122:3306" user="admin"</span><br><span class="line">  				   password="Abc_123456"&gt;</span><br><span class="line">  			&lt;readHost host="W2R1" url="192.168.99.121:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  			&lt;readHost host="W2R2" url="192.168.99.123:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  		&lt;/writeHost&gt;</span><br><span class="line">  	&lt;/dataHost&gt;</span><br><span class="line">&lt;/mycat:schema&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改rule.xml文件，把mod-long的count值修改成2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;function name="mod-long" class="io.mycat.route.function.PartitionByMod"&gt;</span><br><span class="line">	&lt;property name="count"&gt;2&lt;/property&gt;</span><br><span class="line">&lt;/function&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启MyCat</p>
</li>
<li><p>向t_user表写入数据，感受数据的切分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">USE test;</span><br><span class="line">#第一条记录被切分到第二个分片</span><br><span class="line">INSERT INTO t_user(id,username,password,tel,locked) VALUES(1,&quot;A&quot;,HEX(AES_ENCRYPT(&apos;123456&apos;,&apos;HelloWorld&apos;)));</span><br><span class="line">#第二条记录被切分到第一个分片</span><br><span class="line">INSERT INTO t_user(id,username,password,tel,locked) VALUES(2,&quot;B&quot;,HEX(AES_ENCRYPT(&apos;123456&apos;,&apos;HelloWorld&apos;)));</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="4-配置父子表"><a href="#4-配置父子表" class="headerlink" title="4. 配置父子表"></a>4. 配置父子表</h2><ol>
<li><p>在conf目录下创建<code>customer-hash-int</code>文件，内容如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">101</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">102</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">103</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">104</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">105</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">106</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在rule.xml文件中加入自定义<function>和<tablerule></tablerule></function></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"customer-hash-int"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByFileMap"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapFile"</span>&gt;</span>customer-hash-int.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"sharding-customer"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">columns</span>&gt;</span>sharding_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>customer-hash-int<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改schema.xml文件，添加父子表定义</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"t_customer"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">rule</span>=<span class="string">"sharding-customer"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">"t_orders"</span> <span class="attr">primaryKey</span>=<span class="string">"ID"</span> <span class="attr">joinKey</span>=<span class="string">"customer_id"</span> 	</span></span><br><span class="line"><span class="tag">                <span class="attr">parentKey</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在MyCat上执行如下SQL：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">USE test;</span><br><span class="line">CREATE TABLE t_customer(</span><br><span class="line">	id INT UNSIGNED PRIMARY KEY,</span><br><span class="line">    username VARCHAR(200) NOT NULL,</span><br><span class="line">    sharding_id INT NOT NULL</span><br><span class="line">);</span><br><span class="line">CREATE TABLE t_orders(</span><br><span class="line">	id INT UNSIGNED PRIMARY KEY,</span><br><span class="line">    customer_id INT NOT NULL,</span><br><span class="line">    datetime TIMESTAMP DEFAULT CURRENT_TIMSTAMP</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>向t_customer表和t_orders表写入数据，查看字表数据跟随父表切分到同一个分片</p>
</li>
</ol>
<h2 id="5-创建双机热备的MyCat集群"><a href="#5-创建双机热备的MyCat集群" class="headerlink" title="5. 创建双机热备的MyCat集群"></a>5. 创建双机热备的MyCat集群</h2><ol>
<li><p>用两个虚拟机实例，各自部署MyCat</p>
</li>
<li><p>用一个虚拟机实例部署Haproxy</p>
<ul>
<li><p>安装Haproxy</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y haproxy</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/haproxy/haproxy.cfg</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line"></span><br><span class="line">listen   admin_stats  </span><br><span class="line">    bind    0.0.0.0:4001</span><br><span class="line">    mode  http</span><br><span class="line">    stats uri       /dbs</span><br><span class="line">    stats realm  Global\ statistics</span><br><span class="line">    stats auth    admin:abc123456</span><br><span class="line">listen   proxy-mysql</span><br><span class="line">    bind    0.0.0.0:3306  </span><br><span class="line">    mode  tcp </span><br><span class="line">    balance  roundrobin</span><br><span class="line">    option  tcplog       #日志格式</span><br><span class="line">    server   mycat_1  192.168.99.131:3306  check  port  8066  maxconn  2000  </span><br><span class="line">    server   mycat_2  192.168.99.132:3306  check  port  8066  maxconn  2000  </span><br><span class="line">    option  tcpka        #使用keepalive检测死链</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动Haproxy</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service haproxy start</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问Haproxy监控画面</p>
<p><a href="http://192.168.99.131:4001/dbs" target="_blank" rel="noopener">http://192.168.99.131:4001/dbs</a></p>
</li>
</ul>
</li>
<li><p>用另外一个虚拟机同样按照上述操作安装Haproxy</p>
</li>
<li><p>在某个Haproxy虚拟机实例上部署Keepalived</p>
<ul>
<li><p>开启防火墙的VRRP协议</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>开启VRRP</span><br><span class="line">firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --protocol  vrrp -j ACCEPT</span><br><span class="line"><span class="meta">#</span>应用设置</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Keepalived</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance  VI_1 &#123;</span><br><span class="line">    state  MASTER</span><br><span class="line">    interface  ens33</span><br><span class="line">    virtual_router_id  51</span><br><span class="line">    priority  100</span><br><span class="line">    advert_int  1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type  PASS</span><br><span class="line">        auth_pass  123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.133</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动Keepalived</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service keepalived start</span><br></pre></td></tr></table></figure>
</li>
<li><p>ping 192.168.99.133</p>
</li>
</ul>
</li>
<li><p>在另外一个Haproxy虚拟机上，按照上述方法部署Keepalived</p>
</li>
<li><p>使用MySQL客户端连接192.168.99.133，执行增删改查数据</p>
</li>
</ol>
<h1 id="四、Sysbench基准测试"><a href="#四、Sysbench基准测试" class="headerlink" title="四、Sysbench基准测试"></a>四、Sysbench基准测试</h1><h2 id="1-安装Sysbench"><a href="#1-安装Sysbench" class="headerlink" title="1. 安装Sysbench"></a>1. 安装Sysbench</h2><ul>
<li><p>在线安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://packagecloud.io/install/</span><br><span class="line">repositories/akopytov/sysbench/script.rpm.sh | sudo bash</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install sysbench</span><br></pre></td></tr></table></figure>
</li>
<li><p>本地安装</p>
<ul>
<li><p>下载压缩文件</p>
<p><a href="https://codeload.github.com/akopytov/sysbench/zip/1.0" target="_blank" rel="noopener">https://</a><a href="https://codeload.github.com/akopytov/sysbench/zip/1.0" target="_blank" rel="noopener">codeload.github.com/akopytov/sysbench/zip/1.0</a></p>
</li>
<li><p>安装依赖包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y automake libtool</span><br><span class="line">yum install -y mysql-devel</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>cd sysbench</span><br><span class="line">./autogen.sh </span><br><span class="line">./configure </span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">sysbench --version</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="2-执行测试"><a href="#2-执行测试" class="headerlink" title="2. 执行测试"></a>2. 执行测试</h2><ul>
<li><p>准备测试库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench  /usr/share/sysbench/tests/include/oltp_legacy/oltp.lua --mysql-host=192.168.99.131 --mysql-port=3306 --mysql-user=admin --mysql-password=Abc_123456 --oltp-tables-count=10 --oltp-table-size=100000 prepare</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench  /usr/share/sysbench/tests/include/oltp_legacy/oltp.lua --mysql-host=192.168.99.131 --mysql-port=3306 --mysql-user=admin --mysql-password=Abc_123456 --oltp-test-mode=complex --threads=10 --time=300 --report-interval=10 run &gt;&gt; /home/mysysbench.log</span><br></pre></td></tr></table></figure>
</li>
<li><p>清理数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench /usr/share/sysbench/tests/include/oltp_legacy/oltp.lua --mysql-host=192.168.99.131 --mysql-port=3306 --mysql-user=admin --mysql-password=Abc_123456 --oltp-tables-count=10 cleanup</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="五、tpcc-mysql-压力测试"><a href="#五、tpcc-mysql-压力测试" class="headerlink" title="五、tpcc-mysql 压力测试"></a>五、tpcc-mysql 压力测试</h1><h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h2><ul>
<li><p>修改my.cnf配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br></pre></td></tr></table></figure>
<p>pxc_strict_mode=DISABLED</p>
</li>
<li><p>修改某个Haproxy的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server   mysql_1  192.168.99.151:3306  check  port  3306  weight  1  maxconn  2000</span><br><span class="line">server   mysql_2  192.168.99.159:3306  check  port  3306  weight  1  maxconn  2000</span><br><span class="line">server   mysql_3  192.168.99.215:3306  check  port  3306  weight  1  maxconn  2000</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新启动Haproxy</p>
</li>
<li><p>安装依赖程序包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc</span><br><span class="line">yum install -y mysql-devel</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="2-安装tpcc-mysql"><a href="#2-安装tpcc-mysql" class="headerlink" title="2. 安装tpcc-mysql"></a>2. 安装tpcc-mysql</h2><ul>
<li><p>下载压缩包</p>
<p><a href="https://codeload.github.com/Percona-Lab/tpcc-mysql/zip/master" target="_blank" rel="noopener">https://codeload.github.com/Percona-Lab/tpcc-mysql/zip/</a><a href="https://codeload.github.com/Percona-Lab/tpcc-mysql/zip/master" target="_blank" rel="noopener">master</a></p>
</li>
<li><p>执行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>cd tpcc的src目录</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行<code>create_table.sql</code>和<code>add_fkey_idx.sql</code>两个文件</p>
</li>
<li><p>执行数据初始化</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./tpcc_load -h 192.168.99.131 -d tpcc -u admin -p Abc_123456 -w</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行压力测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./tpcc_start -h 192.168.99.131 -d tpcc -u admin -p Abc_123456 -w 1 -c 5 -r 300 -l 600 -&gt;tpcc-output-log</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="六、导入数据"><a href="#六、导入数据" class="headerlink" title="六、导入数据"></a>六、导入数据</h1><h2 id="1-生成1000万条数据"><a href="#1-生成1000万条数据" class="headerlink" title="1. 生成1000万条数据"></a>1. 生成1000万条数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileWriter</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">	<span class="function">def <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> writer=<span class="keyword">new</span> FileWriter(<span class="string">"D:/data.txt"</span>)</span><br><span class="line">		<span class="keyword">var</span> buff=<span class="keyword">new</span> BufferedWriter(writer)</span><br><span class="line">		<span class="keyword">for</span>(i:<span class="number">1</span>..<span class="number">10000000</span>)&#123;</span><br><span class="line">			buff.write(i+<span class="string">",测试数据\n"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		buff.close</span><br><span class="line">		writer.close</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-执行文件切分"><a href="#2-执行文件切分" class="headerlink" title="2. 执行文件切分"></a>2. 执行文件切分</h2><ul>
<li><p>上传data.txt文件到linux</p>
</li>
<li><p>执行文件切分</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">split -l 1000000 -d data.txt</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="3-准备数据库"><a href="#3-准备数据库" class="headerlink" title="3. 准备数据库"></a>3. 准备数据库</h2><ul>
<li><p>每个PXC分片只开启一个节点</p>
</li>
<li><p>修改PXC节点文件，然后重启PXC服务</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">innodb_flush_log_at_trx_commit</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">innodb_flush_method</span> = O_DIRECT</span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span> = <span class="number">200</span>M</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建t_test数据表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t_test(</span><br><span class="line">	id INT UNSIGNED PRIMARY KEY,</span><br><span class="line">    name VARCHAR(200) NOT NULL</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置MyCat</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"t_test"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">rule</span>=<span class="string">"mod-long"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"cluster1"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"0"</span> <span class="attr">writeType</span>=<span class="string">"1"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"1"</span> <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"W1"</span> <span class="attr">url</span>=<span class="string">"192.168.99.151:3306"</span> <span class="attr">user</span>=<span class="string">"admin"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">password</span>=<span class="string">"Abc_123456"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"cluster2"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"0"</span> <span class="attr">writeType</span>=<span class="string">"1"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"1"</span> <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"W1"</span> <span class="attr">url</span>=<span class="string">"192.168.99.121:3306"</span> <span class="attr">user</span>=<span class="string">"admin"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">password</span>=<span class="string">"Abc_123456"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="4-执行Java程序，多线程导入数据"><a href="#4-执行Java程序，多线程导入数据" class="headerlink" title="4. 执行Java程序，多线程导入数据"></a>4. 执行Java程序，多线程导入数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.eclipse.xtend.lib.annotations.Accessors</span><br><span class="line"><span class="keyword">import</span> java.io.File</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">	<span class="meta">@Accessors</span></span><br><span class="line">	File file;</span><br><span class="line">	</span><br><span class="line">	<span class="function">override <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> url=<span class="string">"jdbc:mysql://192.168.99.131:8066/test"</span></span><br><span class="line">		<span class="keyword">var</span> username=<span class="string">"admin"</span></span><br><span class="line">		<span class="keyword">var</span> password=<span class="string">"Abc_123456"</span></span><br><span class="line">		<span class="keyword">var</span> con=DriverManager.getConnection(url,username,password)</span><br><span class="line">		<span class="keyword">var</span> sql=<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">			load data local intfile '</span>/home/data/«file.name»<span class="string">' ignore into table t_test </span></span><br><span class="line"><span class="string">			character set '</span>utf8<span class="string">' </span></span><br><span class="line"><span class="string">			fields terminated by '</span>,<span class="string">' optionally enclosed by '</span>\<span class="string">"' </span></span><br><span class="line"><span class="string">			lines terminated by '\n' (id,name);</span></span><br><span class="line"><span class="string">		'''</span></span><br><span class="line"><span class="string">		var pst=con.prepareStatement(sql);</span></span><br><span class="line"><span class="string">		pst.execute</span></span><br><span class="line"><span class="string">		con.close</span></span><br><span class="line"><span class="string">		LoadData.updateNum();</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.mysql.jdbc.Driver</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingQueue</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit</span><br><span class="line"><span class="keyword">import</span> java.io.File</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoadData</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> <span class="keyword">static</span> <span class="keyword">int</span> num=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">var</span> <span class="keyword">static</span> <span class="keyword">int</span> end=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">var</span> <span class="keyword">static</span> pool=<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>,<span class="number">5</span>,<span class="number">60</span>,TimeUnit.SECONDS,<span class="keyword">new</span> LinkedBlockingQueue(<span class="number">200</span>))</span><br><span class="line">	<span class="function">def <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		DriverManager.registerDriver(<span class="keyword">new</span> Driver)</span><br><span class="line">		<span class="keyword">var</span> folder=<span class="keyword">new</span> File(<span class="string">"/home/data"</span>)</span><br><span class="line">		<span class="keyword">var</span> files=folder.listFiles</span><br><span class="line">		end=files.length <span class="comment">//线程池结束条件</span></span><br><span class="line">		files.forEach[one|</span><br><span class="line">			<span class="keyword">var</span> task=<span class="keyword">new</span> Task();</span><br><span class="line">			task.file=one;</span><br><span class="line">			pool.execute(task)</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">synchronized</span> def <span class="keyword">static</span> <span class="title">updateNum</span><span class="params">()</span></span>&#123;</span><br><span class="line">		num++;</span><br><span class="line">		<span class="keyword">if</span>(num==end)&#123;</span><br><span class="line">			pool.shutdown();</span><br><span class="line">			println(<span class="string">"执行结束"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="七、大数据归档"><a href="#七、大数据归档" class="headerlink" title="七、大数据归档"></a>七、大数据归档</h1><h2 id="1-安装TokuDB"><a href="#1-安装TokuDB" class="headerlink" title="1. 安装TokuDB"></a>1. 安装TokuDB</h2><ul>
<li><p>安装jemlloc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y jemalloc</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">……</span><br><span class="line"><span class="section">[mysqld_safe]</span></span><br><span class="line"><span class="attr">malloc-lib</span>=/usr/lib64/libjemalloc.so.<span class="number">1</span></span><br><span class="line">……</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启MySQL</p>
</li>
<li><p>开启Linux大页内存</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装TokuDB</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y Percona-Server-tokudb-57.x86_64</span><br><span class="line">ps-admin --enable -uroot -p</span><br><span class="line">service mysql restart</span><br><span class="line">ps-admin --enable -uroot -p</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看安装结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show engines ;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="2-配置Replication集群"><a href="#2-配置Replication集群" class="headerlink" title="2. 配置Replication集群"></a>2. 配置Replication集群</h2><ul>
<li><p>在两个TokuDB数据库上创建用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &apos;backup&apos;@&apos;%&apos; IDENTIFIED BY &apos;Abc_123456&apos; ;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT super, reload, replication slave ON *.* TO &apos;backup&apos;@&apos;%&apos; ;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLUSH  PRIVILEGES ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改两个TokuDB的配置文件，如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="number">101</span></span><br><span class="line"><span class="attr">log_bin</span> = mysql_bin</span><br><span class="line"><span class="attr">relay_log</span> = relay_bin</span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="number">102</span></span><br><span class="line"><span class="attr">log_bin</span> = mysql_bin</span><br><span class="line"><span class="attr">relay_log</span> = relay_bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新启动两个TokuDB节点</p>
</li>
<li><p>分别在两个TokuDB上执行下面4句SQL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#关闭同步服务</span><br><span class="line">stop slave;</span><br><span class="line">#设置同步的Master节点</span><br><span class="line">change master to master_host=&quot;192.168.99.155&quot;,master_port=3306,master_user=&quot;backup&quot;,</span><br><span class="line">master_password=&quot;Abc_123456&quot;;</span><br><span class="line">#启动同步服务</span><br><span class="line">start slave;</span><br><span class="line">#查看同步状态</span><br><span class="line">show slave status;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#关闭同步服务</span><br><span class="line">stop slave;</span><br><span class="line">#设置同步的Master节点</span><br><span class="line">change master to master_host=&quot;192.168.99.102&quot;,master_port=3306,master_user=&quot;backup&quot;,</span><br><span class="line">master_password=&quot;Abc_123456&quot;;</span><br><span class="line">#启动同步服务</span><br><span class="line">start slave;</span><br><span class="line">#查看同步状态</span><br><span class="line">show slave status;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="3-创建归档表"><a href="#3-创建归档表" class="headerlink" title="3. 创建归档表"></a>3. 创建归档表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t_purchase (</span><br><span class="line">	id INT UNSIGNED PRIMARY KEY,</span><br><span class="line">	purchase_price DECIMAL(10,2) NOT NULL,</span><br><span class="line">	purchase_num INT UNSIGNED NOT NULL,</span><br><span class="line">	purchase_sum DECIMAL (10,2) NOT NULL,</span><br><span class="line">	purchase_buyer INT UNSIGNED NOT NULL,</span><br><span class="line">	purchase_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">	company_id INT UNSIGNED NOT NULL,</span><br><span class="line">	goods_id INT UNSIGNED NOT NULL,</span><br><span class="line">	KEY idx_company_id(company_id),</span><br><span class="line">	KEY idx_goods_id(goods_id)</span><br><span class="line">)engine=TokuDB;</span><br></pre></td></tr></table></figure>
<h2 id="4-配置Haproxy-Keepalived双机热备"><a href="#4-配置Haproxy-Keepalived双机热备" class="headerlink" title="4. 配置Haproxy+Keepalived双机热备"></a>4. 配置Haproxy+Keepalived双机热备</h2><ul>
<li><p>在两个节点上安装Haproxy</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y haproxy</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/haproxy/haproxy.cfg</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line"></span><br><span class="line">listen   admin_stats  </span><br><span class="line">    bind    0.0.0.0:4001</span><br><span class="line">    mode  http</span><br><span class="line">    stats uri       /dbs</span><br><span class="line">    stats realm  Global\ statistics</span><br><span class="line">    stats auth    admin:abc123456</span><br><span class="line">listen   proxy-mysql</span><br><span class="line">    bind    0.0.0.0:4002  </span><br><span class="line">    mode  tcp </span><br><span class="line">    balance  roundrobin</span><br><span class="line">    option  tcplog       #日志格式</span><br><span class="line">    server   backup_1  192.168.99.102:3306  check  port  3306  maxconn  2000  </span><br><span class="line">    server   backup_2  192.168.99.155:3306  check  port  3306  maxconn  2000  </span><br><span class="line">    option  tcpka        #使用keepalive检测死链</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启Haproxy</p>
</li>
<li><p>开启防火墙的VRRP协议</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --protocol vrrp -j ACCEPT</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>在两个节点上安装Keepalived</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑Keepalived配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance  VI_1 &#123;</span><br><span class="line">    state  MASTER</span><br><span class="line">    interface  ens33</span><br><span class="line">    virtual_router_id  51</span><br><span class="line">    priority  100</span><br><span class="line">    advert_int  1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type  PASS</span><br><span class="line">        auth_pass  123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.211</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启Keepalived</p>
</li>
</ul>
<h2 id="5-准备归档数据"><a href="#5-准备归档数据" class="headerlink" title="5. 准备归档数据"></a>5. 准备归档数据</h2><ul>
<li><p>在两个PXC分片上创建进货表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t_purchase (</span><br><span class="line">	id INT UNSIGNED PRIMARY KEY,</span><br><span class="line">	purchase_price DECIMAL(10,2) NOT NULL,</span><br><span class="line">	purchase_num INT UNSIGNED NOT NULL,</span><br><span class="line">	purchase_sum DECIMAL (10,2) NOT NULL,</span><br><span class="line">	purchase_buyer INT UNSIGNED NOT NULL,</span><br><span class="line">	purchase_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">	company_id INT UNSIGNED NOT NULL,</span><br><span class="line">	goods_id INT UNSIGNED NOT NULL,</span><br><span class="line">	KEY idx_company_id(company_id),</span><br><span class="line">	KEY idx_goods_id(goods_id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置MyCat的schema.xml文件，并重启MyCat</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"t_purchase"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">rule</span>=<span class="string">"mod-long"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="6-执行数据归档"><a href="#6-执行数据归档" class="headerlink" title="6. 执行数据归档"></a>6. 执行数据归档</h2><ul>
<li><p>安装pt-archiver</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install percona-toolkit</span><br><span class="line">pt-archiver --version</span><br><span class="line">pt-archiver --help</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行数据归档</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-archiver --source h=192.168.99.102,P=8066,u=admin,p=Abc_123456,D=test,t=t_purchase --dest h=192.168.99.102,P=3306,u=admin,p=Abc_123456,D=test,t=t_purchase --no-check-charset --where 'purchase_date&lt;"2018-09"' --progress 5000 --bulk-delete --bulk-insert --limit=10000 --statistics</span><br></pre></td></tr></table></figure>
</li>
</ul>

            <div class="post-copyright">
    <div class="content">
        <p>最后更新： 2019年03月18日 22:32</p>
        <p>原始链接： <a class="post-url" href="/2019/03/18/MySQL数据库集群-PXC方案/" title="MySQL数据库集群-PXC方案">https://zem12345678.github.io/2019/03/18/MySQL数据库集群-PXC方案/</a></p>
        <footer>
            <a href="https://zem12345678.github.io">
                <img src="/images/logo.png" alt="Enmin">
                Enmin
            </a>
        </footer>
    </div>
</div>

      
        
            
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;">赏</a>
</div>

<div id="reward" class="post-modal reward-lay">
    <a class="close" href="javascript:;" id="reward-close">×</a>
    <span class="reward-title">
        <i class="icon icon-quote-left"></i>
        请我吃糖~
        <i class="icon icon-quote-right"></i>
    </span>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/images/wx.png" alt="打赏二维码">
        </div>
        <div class="reward-select">
            
            <label class="reward-select-item checked" data-id="wechat" data-wechat="/images/wx.png">
                <img class="reward-select-item-wechat" src="/images/wechat.png" alt="微信">
            </label>
            
            
            <label class="reward-select-item" data-id="alipay" data-alipay="/images/zfb.png">
                <img class="reward-select-item-alipay" src="/images/alipay.png" alt="支付宝">
            </label>
            
        </div>
    </div>
</div>


        
    </div>
    <footer class="article-footer">
        
        
<div class="post-share">
    <a href="javascript:;" id="share-sub" class="post-share-fab">
        <i class="fa fa-share-alt"></i>
    </a>
    <div class="post-share-list" id="share-list">
        <ul class="share-icons">
          <li>
            <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://zem12345678.github.io/2019/03/18/MySQL数据库集群-PXC方案/&title=《MySQL数据库集群-PXC方案》 — Enmin`s blog&pic=images/40.jpg" data-title="微博">
              <i class="fa fa-weibo"></i>
            </a>
          </li>
          <li>
            <a class="weixin share-sns" id="wxFab" href="javascript:;" data-title="微信">
              <i class="fa fa-weixin"></i>
            </a>
          </li>
          <li>
            <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://zem12345678.github.io/2019/03/18/MySQL数据库集群-PXC方案/&title=《MySQL数据库集群-PXC方案》 — Enmin`s blog&source=" data-title="QQ">
              <i class="fa fa-qq"></i>
            </a>
          </li>
          <li>
            <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://zem12345678.github.io/2019/03/18/MySQL数据库集群-PXC方案/" data-title="Facebook">
              <i class="fa fa-facebook"></i>
            </a>
          </li>
          <li>
            <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《MySQL数据库集群-PXC方案》 — Enmin`s blog&url=https://zem12345678.github.io/2019/03/18/MySQL数据库集群-PXC方案/&via=https://zem12345678.github.io" data-title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
          <li>
            <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://zem12345678.github.io/2019/03/18/MySQL数据库集群-PXC方案/" data-title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        </ul>
     </div>
</div>
<div class="post-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;" id="wxShare-close">×</a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://zem12345678.github.io/2019/03/18/MySQL数据库集群-PXC方案/" alt="微信分享二维码">
</div>

<div class="mask"></div>

        
        <ul class="article-footer-menu">
            
            
  <li class="article-footer-tags">
    <i class="fa fa-tags"></i>
      
    <a href="/tags/Mysql/" class="color1">Mysql</a>
      
    <a href="/tags/数据库集群/" class="color1">数据库集群</a>
      
  </li>

        </ul>
        
    </footer>
  </div>
</article>


    <aside class="post-toc-pos post-toc-top" id="post-toc">
        <nav class="post-toc-wrap">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#一、安装Percona数据库"><span class="post-toc-text">一、安装Percona数据库</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-离线安装Percona"><span class="post-toc-text">1. 离线安装Percona</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-在线安装Percona"><span class="post-toc-text">2. 在线安装Percona</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-开放防火墙端口"><span class="post-toc-text">3. 开放防火墙端口</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#4-修改MySQL配置文件"><span class="post-toc-text">4. 修改MySQL配置文件</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#5-禁止开机启动MySQL"><span class="post-toc-text">5. 禁止开机启动MySQL</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#6-初始化MySQL数据库"><span class="post-toc-text">6. 初始化MySQL数据库</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#二、创建PXC集群"><span class="post-toc-text">二、创建PXC集群</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-删除MariaDB程序包"><span class="post-toc-text">1. 删除MariaDB程序包</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-开放防火墙端口"><span class="post-toc-text">2. 开放防火墙端口</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-关闭SELINUX"><span class="post-toc-text">3. 关闭SELINUX</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#4-离线安装PXC"><span class="post-toc-text">4. 离线安装PXC</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#5-创建PXC集群"><span class="post-toc-text">5. 创建PXC集群</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#6-PXC节点启动与关闭"><span class="post-toc-text">6. PXC节点启动与关闭</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#三、安装MyCat"><span class="post-toc-text">三、安装MyCat</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-JDK安装与配置"><span class="post-toc-text">1. JDK安装与配置</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-创建数据表"><span class="post-toc-text">2. 创建数据表</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-MyCat安装与配置"><span class="post-toc-text">3. MyCat安装与配置</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#4-配置父子表"><span class="post-toc-text">4. 配置父子表</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#5-创建双机热备的MyCat集群"><span class="post-toc-text">5. 创建双机热备的MyCat集群</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#四、Sysbench基准测试"><span class="post-toc-text">四、Sysbench基准测试</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-安装Sysbench"><span class="post-toc-text">1. 安装Sysbench</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-执行测试"><span class="post-toc-text">2. 执行测试</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#五、tpcc-mysql-压力测试"><span class="post-toc-text">五、tpcc-mysql 压力测试</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-准备工作"><span class="post-toc-text">1. 准备工作</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-安装tpcc-mysql"><span class="post-toc-text">2. 安装tpcc-mysql</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#六、导入数据"><span class="post-toc-text">六、导入数据</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-生成1000万条数据"><span class="post-toc-text">1. 生成1000万条数据</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-执行文件切分"><span class="post-toc-text">2. 执行文件切分</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-准备数据库"><span class="post-toc-text">3. 准备数据库</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#4-执行Java程序，多线程导入数据"><span class="post-toc-text">4. 执行Java程序，多线程导入数据</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#七、大数据归档"><span class="post-toc-text">七、大数据归档</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-安装TokuDB"><span class="post-toc-text">1. 安装TokuDB</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-配置Replication集群"><span class="post-toc-text">2. 配置Replication集群</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-创建归档表"><span class="post-toc-text">3. 创建归档表</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#4-配置Haproxy-Keepalived双机热备"><span class="post-toc-text">4. 配置Haproxy+Keepalived双机热备</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#5-准备归档数据"><span class="post-toc-text">5. 准备归档数据</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#6-执行数据归档"><span class="post-toc-text">6. 执行数据归档</span></a></li></ol></li></ol>
        </nav>
    </aside>
    

<nav id="article-nav">
  
    <a href="/2019/05/16/str和bytes的区别/" id="article-nav-newer" class="article-nav-link-wrap">

      <span class="article-nav-title">
        <i class="fa fa-hand-o-left" aria-hidden="true"></i>
        
          str和bytes的区别
        
      </span>
    </a>
  
  
    <a href="/2019/03/18/elasticsearch与MySQL数据同步/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-title">elasticsearch与MySQL数据同步</span>
      <i class="fa fa-hand-o-right" aria-hidden="true"></i>
    </a>
  
</nav>



    
        <div id="SOHUCS" sid="MySQL数据库集群-PXC方案" ></div>
<script type="text/javascript">
    (function(){
        var appid = 'cytRXLIlH';
        var conf = '983bf9e4c3b1e70e33660721bdb62bb2';
        var width = window.innerWidth || document.documentElement.clientWidth;
        if (width < 960) {
            window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>
    
</section>
        
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        总访客数：20<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        总访问量：20<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


      <p>
        Powered by  <a href="http://hexo.io/" target="_blank">Hexo</a>
        Theme <a href="//github.com/wongminho/hexo-theme-miho" target="_blank">MiHo</a>
      &copy; 2019 Enmin<br>
      </p>
    </div>
  </div>
</footer>
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script>
  var mihoConfig = {
      root: "https://zem12345678.github.io",
      animate: true,
      isHome: false,
      share: true,
      reward: 1
  }
</script>
<div class="sidebar">
    <div id="sidebar-search" title="Search">
        <i class="fa fa-search"></i>
    </div>
    <div id="sidebar-category" title="Categories">
        <i class="fa fa-book"></i>
    </div>
    <div id="sidebar-tag" title="Tags">
        <i class="fa fa-tags"></i>
    </div>
    <div id="sidebar-top">
        <span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span>
    </div>
</div>
<div class="sidebar-menu-box" id="sidebar-menu-box">
    <div class="sidebar-menu-box-container">
        <div id="sidebar-menu-box-categories">
            <a class="category-link" href="/categories/Django/">Django</a><a class="category-link" href="/categories/Docker/">Docker</a><a class="category-link" href="/categories/FastDFS/">FastDFS</a><a class="category-link" href="/categories/Flask/">Flask</a><a class="category-link" href="/categories/JWT/">JWT</a><a class="category-link" href="/categories/Machine-learning/">Machine learning</a><a class="category-link" href="/categories/Python/">Python</a><a class="category-link" href="/categories/Redis/">Redis</a><a class="category-link" href="/categories/django/">django</a><a class="category-link" href="/categories/前后端分离/">前后端分离</a><a class="category-link" href="/categories/前端/">前端</a><a class="category-link" href="/categories/大数据/">大数据</a><a class="category-link" href="/categories/学习笔记/">学习笔记</a><a class="category-link" href="/categories/并行计算/">并行计算</a><a class="category-link" href="/categories/异步处理/">异步处理</a><a class="category-link" href="/categories/数据库/">数据库</a><a class="category-link" href="/categories/数据挖掘/">数据挖掘</a><a class="category-link" href="/categories/杂谈/">杂谈</a><a class="category-link" href="/categories/算法/">算法</a><a class="category-link" href="/categories/网络原理/">网络原理</a><a class="category-link" href="/categories/随堂笔记/">随堂笔记</a>
        </div>
        <div id="sidebar-menu-box-tags">
            <a href="/tags/BeautifuSoup4/" style="font-size: 10px;">BeautifuSoup4</a> <a href="/tags/BeautifulSoup4/" style="font-size: 10px;">BeautifulSoup4</a> <a href="/tags/C-C/" style="font-size: 10px;">C/C++</a> <a href="/tags/Django/" style="font-size: 18.75px;">Django</a> <a href="/tags/Docker/" style="font-size: 12.5px;">Docker</a> <a href="/tags/ElasticSearch/" style="font-size: 11.25px;">ElasticSearch</a> <a href="/tags/FastDFS/" style="font-size: 12.5px;">FastDFS</a> <a href="/tags/Flask/" style="font-size: 12.5px;">Flask</a> <a href="/tags/Gunicorn/" style="font-size: 10px;">Gunicorn</a> <a href="/tags/HTTP-HTTPS/" style="font-size: 11.25px;">HTTP/HTTPS</a> <a href="/tags/Hadoop/" style="font-size: 10px;">Hadoop</a> <a href="/tags/Java/" style="font-size: 11.25px;">Java</a> <a href="/tags/Jwt/" style="font-size: 11.25px;">Jwt</a> <a href="/tags/LeetCode/" style="font-size: 10px;">LeetCode</a> <a href="/tags/LeetCood/" style="font-size: 11.25px;">LeetCood</a> <a href="/tags/Machine-learning/" style="font-size: 12.5px;">Machine learning</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Mpi/" style="font-size: 10px;">Mpi</a> <a href="/tags/Mysql/" style="font-size: 11.25px;">Mysql</a> <a href="/tags/Nginx/" style="font-size: 11.25px;">Nginx</a> <a href="/tags/Python/" style="font-size: 17.5px;">Python</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Requests/" style="font-size: 10px;">Requests</a> <a href="/tags/Restful/" style="font-size: 12.5px;">Restful</a> <a href="/tags/Scrapy/" style="font-size: 16.25px;">Scrapy</a> <a href="/tags/Spring/" style="font-size: 10px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 10px;">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/Token/" style="font-size: 11.25px;">Token</a> <a href="/tags/Urllib/" style="font-size: 10px;">Urllib</a> <a href="/tags/Vue/" style="font-size: 11.25px;">Vue</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/XPath/" style="font-size: 11.25px;">XPath</a> <a href="/tags/python/" style="font-size: 11.25px;">python</a> <a href="/tags/决策树分类/" style="font-size: 10px;">决策树分类</a> <a href="/tags/分布式/" style="font-size: 12.5px;">分布式</a> <a href="/tags/前后端分离/" style="font-size: 13.75px;">前后端分离</a> <a href="/tags/前端/" style="font-size: 10px;">前端</a> <a href="/tags/回归分类/" style="font-size: 10px;">回归分类</a> <a href="/tags/大数据/" style="font-size: 10px;">大数据</a> <a href="/tags/容器/" style="font-size: 11.25px;">容器</a> <a href="/tags/富文本/" style="font-size: 10px;">富文本</a> <a href="/tags/微服务/" style="font-size: 10px;">微服务</a> <a href="/tags/搜索引擎/" style="font-size: 11.25px;">搜索引擎</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/数据库集群/" style="font-size: 10px;">数据库集群</a> <a href="/tags/数据结构/" style="font-size: 12.5px;">数据结构</a> <a href="/tags/杂谈/" style="font-size: 10px;">杂谈</a> <a href="/tags/权限认证/" style="font-size: 10px;">权限认证</a> <a href="/tags/正则表达式/" style="font-size: 11.25px;">正则表达式</a> <a href="/tags/消息队列/" style="font-size: 10px;">消息队列</a> <a href="/tags/爬虫/" style="font-size: 20px;">爬虫</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/编码/" style="font-size: 11.25px;">编码</a> <a href="/tags/虚拟化/" style="font-size: 11.25px;">虚拟化</a> <a href="/tags/跨域/" style="font-size: 10px;">跨域</a> <a href="/tags/随机森林/" style="font-size: 10px;">随机森林</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
        </div>
    </div>
    <a href="javascript:;" class="sidebar-menu-box-close">&times;</a>
</div>
<div class="mobile-header-menu-nav" id="mobile-header-menu-nav">
    <div class="mobile-header-menu-container">
        <span class="title">Menus</span>
        <ul class="mobile-header-menu-navbar">
            
            <li>
                <a  href="/">
                    <i class="fa fa-home"></i><span>主页</span>
                </a>
            </li>
            
            <li>
                <a  href="/archives">
                    <i class="fa fa-archive"></i><span>文章</span>
                </a>
            </li>
            
            <li>
                <a  href="/about">
                    <i class="fa fa-user"></i><span>关于我</span>
                </a>
            </li>
            
        </ul>
    </div>
    <div class="mobile-header-tag-container">
        <span class="title">Tags</span>
        <div id="mobile-header-container-tags">
            <a href="/tags/BeautifuSoup4/" style="font-size: 10px;">BeautifuSoup4</a> <a href="/tags/BeautifulSoup4/" style="font-size: 10px;">BeautifulSoup4</a> <a href="/tags/C-C/" style="font-size: 10px;">C/C++</a> <a href="/tags/Django/" style="font-size: 18.75px;">Django</a> <a href="/tags/Docker/" style="font-size: 12.5px;">Docker</a> <a href="/tags/ElasticSearch/" style="font-size: 11.25px;">ElasticSearch</a> <a href="/tags/FastDFS/" style="font-size: 12.5px;">FastDFS</a> <a href="/tags/Flask/" style="font-size: 12.5px;">Flask</a> <a href="/tags/Gunicorn/" style="font-size: 10px;">Gunicorn</a> <a href="/tags/HTTP-HTTPS/" style="font-size: 11.25px;">HTTP/HTTPS</a> <a href="/tags/Hadoop/" style="font-size: 10px;">Hadoop</a> <a href="/tags/Java/" style="font-size: 11.25px;">Java</a> <a href="/tags/Jwt/" style="font-size: 11.25px;">Jwt</a> <a href="/tags/LeetCode/" style="font-size: 10px;">LeetCode</a> <a href="/tags/LeetCood/" style="font-size: 11.25px;">LeetCood</a> <a href="/tags/Machine-learning/" style="font-size: 12.5px;">Machine learning</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Mpi/" style="font-size: 10px;">Mpi</a> <a href="/tags/Mysql/" style="font-size: 11.25px;">Mysql</a> <a href="/tags/Nginx/" style="font-size: 11.25px;">Nginx</a> <a href="/tags/Python/" style="font-size: 17.5px;">Python</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Requests/" style="font-size: 10px;">Requests</a> <a href="/tags/Restful/" style="font-size: 12.5px;">Restful</a> <a href="/tags/Scrapy/" style="font-size: 16.25px;">Scrapy</a> <a href="/tags/Spring/" style="font-size: 10px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 10px;">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/Token/" style="font-size: 11.25px;">Token</a> <a href="/tags/Urllib/" style="font-size: 10px;">Urllib</a> <a href="/tags/Vue/" style="font-size: 11.25px;">Vue</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/XPath/" style="font-size: 11.25px;">XPath</a> <a href="/tags/python/" style="font-size: 11.25px;">python</a> <a href="/tags/决策树分类/" style="font-size: 10px;">决策树分类</a> <a href="/tags/分布式/" style="font-size: 12.5px;">分布式</a> <a href="/tags/前后端分离/" style="font-size: 13.75px;">前后端分离</a> <a href="/tags/前端/" style="font-size: 10px;">前端</a> <a href="/tags/回归分类/" style="font-size: 10px;">回归分类</a> <a href="/tags/大数据/" style="font-size: 10px;">大数据</a> <a href="/tags/容器/" style="font-size: 11.25px;">容器</a> <a href="/tags/富文本/" style="font-size: 10px;">富文本</a> <a href="/tags/微服务/" style="font-size: 10px;">微服务</a> <a href="/tags/搜索引擎/" style="font-size: 11.25px;">搜索引擎</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/数据库集群/" style="font-size: 10px;">数据库集群</a> <a href="/tags/数据结构/" style="font-size: 12.5px;">数据结构</a> <a href="/tags/杂谈/" style="font-size: 10px;">杂谈</a> <a href="/tags/权限认证/" style="font-size: 10px;">权限认证</a> <a href="/tags/正则表达式/" style="font-size: 11.25px;">正则表达式</a> <a href="/tags/消息队列/" style="font-size: 10px;">消息队列</a> <a href="/tags/爬虫/" style="font-size: 20px;">爬虫</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/编码/" style="font-size: 11.25px;">编码</a> <a href="/tags/虚拟化/" style="font-size: 11.25px;">虚拟化</a> <a href="/tags/跨域/" style="font-size: 10px;">跨域</a> <a href="/tags/随机森林/" style="font-size: 10px;">随机森林</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
        </div>
    </div>
</div>
<div class="search-wrap">
    <span class="search-close">&times;</span>
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
            <i class="icon icon-lg icon-chevron-left"></i>
        </a>
        <input class="search-field" placeholder="Search..." id="keywords">
        <a id="search-submit" href="javascript:;">
            <i class="fa fa-search"></i>
        </a>
    <div class="search-container" id="search-container">
        <ul class="search-result" id="search-result">
        </ul>
    </div>
</div>

<div id="search-tpl">
    <li class="search-result-item">
        <a href="{url}" class="search-item-li">
            <span class="search-item-li-title" title="{title}">{title}</span>
        </a>
    </li>
</div>
<script src="/js/search.js"></script>
<script src="/js/main.js"></script>


  <script src="//cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script>
  <div id="particles"></div>
  <script src="/js/particles.js"></script>







  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  <script src="//cdn.bootcss.com/scrollReveal.js/3.0.5/scrollreveal.js"></script>
  <script src="/js/animate.js"></script>


  <script src="/js/pop-img.js"></script>
  <script>
     $(".article-entry p img").popImg();
  </script>

  </div>
</body>
</html>